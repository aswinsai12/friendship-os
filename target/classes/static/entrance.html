<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Happy Birthday üéÇ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
    margin:0;
    overflow:hidden;
    font-family:'Segoe UI', sans-serif;
    background:linear-gradient(135deg,#ff9a9e,#fad0c4);
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
    text-align:center;
}

canvas{
    position:fixed;
    top:0;left:0;
    z-index:0;
}

.card{
    position:relative;
    z-index:2;
    background:white;
    padding:30px;
    border-radius:15px;
    box-shadow:0 10px 25px rgba(0,0,0,0.2);
    max-width:400px;
}

h1{
    font-size:32px;
    opacity:0;
    animation:reveal 2s forwards;
}

@keyframes reveal{to{opacity:1;transform:scale(1.1)}}

#message{margin-top:15px;font-size:18px;min-height:50px}

.cake{font-size:80px;cursor:pointer;margin:20px 0;transition:.5s}
.cake.blown{transform:scale(1.2)}

button{
    padding:12px 25px;
    background:#ff6b6b;
    color:white;
    border:none;
    border-radius:8px;
    font-size:16px;
    cursor:pointer;
}

/* Slideshow overlay */
#slideshow{
    display:none;
    position:fixed;
    inset:0;
    background:black;
    justify-content:center;
    align-items:center;
    z-index:9999;
}

#slideshow img{
    max-width:90%;
    max-height:90%;
    border-radius:15px;
    opacity:0;
    transition:opacity 0.6s ease;
}
</style>
</head>

<body>

<canvas id="confetti"></canvas>

<div class="card">
    <h1>Happy Birthday Jyothendra üéâ</h1>
    <div id="message"></div>
    <div class="cake" id="cake">üéÇ</div>
    <button onclick="goToMemories()">View Memories</button>
</div>

<div id="slideshow">
    <img id="slideImg">
</div>

<script>
/* ================= CONFETTI ================= */
const canvas=document.getElementById("confetti");
const ctx=canvas.getContext("2d");

function resizeCanvas(){
    canvas.width=window.innerWidth;
    canvas.height=window.innerHeight;
}
resizeCanvas();
window.addEventListener("resize",resizeCanvas);

let confetti=[];
for(let i=0;i<150;i++){
    confetti.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,r:Math.random()*6+2});
}
function drawConfetti(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    confetti.forEach(p=>{
        ctx.beginPath();
        ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
        ctx.fillStyle=`hsl(${Math.random()*360},100%,50%)`;
        ctx.fill();
        p.y+=2;
        if(p.y>canvas.height)p.y=0;
    });
    requestAnimationFrame(drawConfetti);
}
drawConfetti();

/* ================= TYPEWRITER ================= */
const msg="Wishing you joy, laughter, and unforgettable memories!";
let i=0;
function typeWriter(){
    if(i<msg.length){
        document.getElementById("message").innerHTML+=msg.charAt(i);
        i++;
        setTimeout(typeWriter,45);
    }
}
typeWriter();

/* ================= FIREWORKS ================= */
document.getElementById("cake").onclick=function(){
    this.classList.add("blown");
    launchFireworks();
};

function launchFireworks(){
    let particles=[];
    for(let i=0;i<80;i++){
        particles.push({x:canvas.width/2,y:canvas.height/2,angle:Math.random()*2*Math.PI,speed:Math.random()*5+3,life:100});
    }
    function animate(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        particles.forEach(p=>{
            p.x+=Math.cos(p.angle)*p.speed;
            p.y+=Math.sin(p.angle)*p.speed;
            p.life--;
            ctx.beginPath();
            ctx.arc(p.x,p.y,3,0,Math.PI*2);
            ctx.fillStyle=`hsl(${Math.random()*360},100%,50%)`;
            ctx.fill();
        });
        particles=particles.filter(p=>p.life>0);
        if(particles.length>0)requestAnimationFrame(animate);
        else drawConfetti(); // restore confetti
    }
    animate();
}

/* ================= SLIDESHOW ================= */
/* ================= SLIDESHOW ================= */
function preload(url) {
    return new Promise((resolve, reject) => {
        const image = new Image();
        image.src = url;
        image.onload = () => resolve(url);
        image.onerror = reject;
    });
}

function goToMemories() {
    fetch("/memory/all")
    .then(res => res.json())
    .then(memories => {

        // ‚úÖ ONLY VALID CLOUDINARY IMAGES
        const images = memories
            .map(m => m.imageUrl)
            .filter(url =>
                url &&
                url.startsWith("https://res.cloudinary.com")
            );

        if (images.length === 0) {
            window.location.href = "/gallery.html";
            return;
        }

        const slideDiv = document.getElementById("slideshow");
        const img = document.getElementById("slideImg");
        slideDiv.style.display = "flex";

        let index = 0;

        async function showNext() {
            if (index >= images.length) {
                window.location.href = "/gallery.html";
                return;
            }

            try {
                await preload(images[index]);

                img.style.opacity = 0;

                setTimeout(() => {
                    img.src = images[index];
                    img.style.opacity = 1;
                }, 300);

                index++;
                setTimeout(showNext, 3500);

            } catch {
                // ‚ùå Bad image ‚Üí skip
                console.log("Skipping bad image:", images[index]);
                index++;
                showNext();
            }
        }

        showNext();
    });
}

</script>
</body>
</html>
